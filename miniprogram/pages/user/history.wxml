<!--user/history.wxml-->
<view class="page-container">
  <!-- å†å²æ¦‚è§ˆ -->
  <view class="history-header">
    <view class="header-content">
      <!-- åˆ—è¡¨æ¨¡å¼ç»Ÿè®¡ -->
      <view class="stats-overview" wx:if="{{viewMode === 'list'}}">
        <view class="stat-item">
          <text class="stat-number">{{totalCheckins}}</text>
          <text class="stat-label">æ€»æ‰“å¡</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{unlockedProvinces}}</text>
          <text class="stat-label">çœä»½</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{thisMonthCheckins}}</text>
          <text class="stat-label">æœ¬æœˆ</text>
        </view>
      </view>

      <!-- åœ°å›¾æ¨¡å¼ç»Ÿè®¡ -->
      <view class="stats-overview" wx:if="{{viewMode === 'map'}}">
        <view class="stat-item">
          <text class="stat-number">{{unlockedProvinces}}/{{totalProvinces}}</text>
          <text class="stat-label">çœä»½</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{visitedNationalMuseums}}/{{totalNationalMuseums}}</text>
          <text class="stat-label">åšç‰©é¦†</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{coverageRate}}%</text>
          <text class="stat-label">è¦†ç›–ç‡</text>
        </view>
      </view>
      
      <view class="progress-bar">
        <view 
          class="progress-fill" 
          style="width: {{coverageRate}}%"
        ></view>
      </view>
      
      <view class="header-actions">
        <view class="view-mode-tabs">
          <view 
            class="mode-tab {{viewMode === 'list' ? 'active' : ''}}"
            bindtap="onViewModeChange"
            data-mode="list"
          >
            <text class="mode-text">æ‰“å¡è®°å½•</text>
          </view>
          <view 
            class="mode-tab {{viewMode === 'map' ? 'active' : ''}}"
            bindtap="onViewModeChange"
            data-mode="map"
          >
            <text class="mode-text">è¶³è¿¹åœ°å›¾</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ‰“å¡è®°å½•è§†å›¾ -->
  <view wx:if="{{viewMode === 'list'}}">
    <!-- æœç´¢æ¡† -->
    <view class="search-section">
      <view class="search-container">
        <input 
          class="search-input"
          type="text"
          placeholder="æœç´¢åšç‰©é¦†ã€çœå¸‚..."
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          bindconfirm="onSearchConfirm"
        />
        <view class="search-btn" bindtap="onSearchConfirm">
          <text class="search-icon">ğŸ”</text>
        </view>
      </view>
    </view>

    <!-- ç­›é€‰å’Œæ’åº -->
    <view class="filter-section">
      <!-- æ—¶é—´ç­›é€‰ -->
      <view class="filter-tabs">
        <view 
          class="filter-tab {{filterType === 'all' ? 'active' : ''}}"
          bindtap="onFilterTap"
          data-type="all"
        >
          <text class="tab-text">å…¨éƒ¨</text>
        </view>
        <view 
          class="filter-tab {{filterType === 'thisMonth' ? 'active' : ''}}"
          bindtap="onFilterTap"
          data-type="thisMonth"
        >
          <text class="tab-text">æœ¬æœˆ</text>
        </view>
        <view 
          class="filter-tab {{filterType === 'thisYear' ? 'active' : ''}}"
          bindtap="onFilterTap"
          data-type="thisYear"
        >
          <text class="tab-text">ä»Šå¹´</text>
        </view>
      </view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-state" wx:if="{{loading}}">
      <text class="loading-text">æœç´¢ä¸­...</text>
    </view>

    <!-- æ‰“å¡è®°å½•åˆ—è¡¨ -->
    <view class="records-section" wx:if="{{!loading}}">
      <view class="records-list">
        <view 
          class="record-card"
          wx:for="{{checkinRecords}}" 
          wx:key="id"
          bindtap="onRecordTap"
          data-id="{{item.id}}"
        >
          <!-- åšç‰©é¦†ä¿¡æ¯ -->
          <view class="record-main">
            <view class="museum-info">
              <view class="museum-header">
                <text class="museum-name">{{item.museumName}}</text>
                <view 
                  class="delete-btn"
                  catchtap="onDeleteRecord"
                  data-id="{{item.id}}"
                  data-name="{{item.museumName}}"
                >
                  <image class="delete-icon" src="/images/delete.svg" mode="aspectFit" />
                </view>
              </view>
              <text class="museum-location">{{item.provinceName}} Â· {{item.cityName}}</text>
              <view class="address-row">
                <text class="museum-address">{{item.address}}</text>
                <text class="checkin-date">{{item.checkInDate}}</text>
              </view>
            </view>
          </view>
          
          <!-- æ‰“å¡ç…§ç‰‡ -->
          <view class="record-photos" wx:if="{{item.photos && item.photos.length > 0}}">
            <image 
              src="{{item.photos[0]}}" 
              class="photo-thumbnail"
              mode="aspectFill"
            />
            <view class="photo-count" wx:if="{{item.photos.length > 1}}">
              <text class="count-text">+{{item.photos.length - 1}}</text>
            </view>
          </view>
          
          <!-- æ‰“å¡ç¬”è®° -->
          <view class="record-notes" wx:if="{{item.notes}}">
            <text class="notes-text">{{item.notes}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- è¶³è¿¹åœ°å›¾è§†å›¾ -->
  <view wx:if="{{viewMode === 'map'}}">
    <!-- çœä»½åœ°å›¾ -->
    <view class="map-section">
      <view class="map-header">
        <text class="map-title">æˆ‘çš„è¶³è¿¹åœ°å›¾</text>
        <text class="map-subtitle">ç‚¹å‡»æŸ¥çœ‹çœä»½è¯¦æƒ…</text>
      </view>
      
      <view class="province-grid">
        <view 
          class="province-card {{item.isUnlocked ? 'unlocked' : 'locked'}}"
          wx:for="{{provinceData}}" 
          wx:key="provinceCode"
          bindtap="onProvinceTap"
          data-code="{{item.provinceCode}}"
        >
          <!-- çœä»½å›¾æ ‡ -->
          <view class="province-icon">
            <text class="province-emoji">{{item.isUnlocked ? 'ğŸ›ï¸' : 'ğŸ”’'}}</text>
          </view>
          
          <!-- çœä»½ä¿¡æ¯ -->
          <view class="province-info">
            <text class="province-name">{{item.provinceName}}</text>
            <text class="province-stats" wx:if="{{item.isUnlocked}}">
              {{item.visitedMuseums}}/{{item.totalMuseums}}
            </text>
            <text class="province-locked" wx:if="{{!item.isUnlocked}}">
              æœªè§£é”
            </text>
          </view>
          
          <!-- å®Œæˆåº¦æŒ‡ç¤ºå™¨ -->
          <view class="completion-indicator" wx:if="{{item.isUnlocked}}">
            <view class="completion-bar">
              <view 
                class="completion-fill" 
                style="width: {{item.visitedMuseums && item.totalMuseums ? (item.visitedMuseums/item.totalMuseums)*100 : 0}}%"
              ></view>
            </view>
            <text class="completion-text">{{item.visitedMuseums && item.totalMuseums ? Math.round((item.visitedMuseums/item.totalMuseums)*100) : 0}}</text>
          </view>
          
          <!-- è§£é”æ ‡è¯† -->
          <view class="unlock-badge" wx:if="{{item.isUnlocked && item.visitedMuseums > 0}}">
            <text class="badge-text">âœ¨</text>
          </view>
        </view>
      </view>
      
      <!-- åœ°å›¾è¯´æ˜ -->
      <view class="map-legend">
        <view class="legend-item">
          <view class="legend-color unlocked"></view>
          <text class="legend-text">å·²æ¢ç´¢çœä»½</text>
        </view>
        <view class="legend-item">
          <view class="legend-color locked"></view>
          <text class="legend-text">æœªæ¢ç´¢çœä»½</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{checkinRecords.length === 0 && viewMode === 'list' && !loading}}">
    <image src="/images/empty-history.png" class="empty-icon" mode="aspectFit" />
    <text class="empty-text">æš‚æ— æ‰“å¡è®°å½•</text>
    <text class="empty-subtitle">å¿«å»æ¢ç´¢åšç‰©é¦†å§ï¼</text>
  </view>

  <!-- åº•éƒ¨é—´è· -->
  <view class="bottom-spacing"></view>
</view>